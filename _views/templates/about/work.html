<section class="col-span-full bg-neutral-900  grid grid-cols-subgrid">
    <header class="col-span-full">
        <h2 class="uppercase text-[.75rem]">{{ count }}/4 What I've Done</h2>
    </header>
    <p class="lead col-span-6 text-neutral-200">
        Twenty years of delivering award-winning, meaningful, and intuitive experiences across a veritable slurry of
        industries. The audiences may change but the goals remain the same: solve real problems for real people.
    </p>
    <ul id="types" class="menu menu-horizontal mx-auto col-span-6 gap-2 mb-8">
        <li>
            <a id="featured"
                class="btn btn-sm  btn-outline text-neutral-200 btn-neutral-200 category btn-active">Featured</a>
        </li>
        {% for category in ia %}
        <li>
            <a id="{{ category.Slug | slugify }}"
                class="btn btn-sm text-neutral-200 btn-outline btn-neutral-200 category">{{ category.Title
                }}</a>
        </li>
        {% endfor %}
        <li>
            <a id="all" class="btn btn-sm btn-outline text-neutral-200 btn-neutral-200 category">All</a>
        </li>
    </ul>
    <figure id="projects" class="align-center row-span-2 col-span-full mx-auto grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6">
        <figcaption class="sr-only">Case Studies</figcaption>
        <ul>
        {% for project in projects | sortByAttribute('Weight') %}
        <li>
            {% set action = ["modal_", project.id, ".showModal()"] | join %}
            <button id="{{ project.id }}" class="project all {% if project.isFeatured %}featured{% endif %} {{ project.CategorySlug }} weight-{{ project.Weight }} link link-hover " onclick="{{ action }}">{{ project.Title }}</button>
            {% include "templates/project/modal.html" %}
        </li>
        {% endfor %}
        </ul>
    </figure>
</section>
<script>

    document.addEventListener("DOMContentLoaded", (event) => {

        let dur = .25; // base value for animation duration (in seconds)
        let y_delta = 0; // vertical origin of elements
        let pos = "-=50%"; // offset (in seconds) of animation relative to the previous

        /** INITIALIZE VIEW */
        // trace("Initialize");
        const projects = gsap.utils.toArray(".project.link");
        projects.forEach(project => {
            project.style.opacity = 0;
            project.classList.add("hidden");
            var prev = gsap.utils.toArray("#modal_" + project.id + " button.prev")[0];
            var next = gsap.utils.toArray("#modal_" + project.id + " button.next")[0];
            prev.addEventListener("click", navigate_projects);
            next.addEventListener("click", navigate_projects);
        });


        /** WELCOME SEQUENCE */
        // let welcome = gsap.timeline();
        // welcome.add(gsap.from("#title h1", {duration: dur, y:y_delta, autoAlpha: 0, ease: "sine.inOut", delay: .5}));
        // welcome.add(gsap.from("#title p", {duration: dur, autoAlpha: 0, ease: "sine.inOut",}), pos);
        // welcome.add(gsap.from('.card.project.featured', {autoAlpha: 0, duration: dur, ease: "sine.inOut"}), pos);
        // welcome.add(gsap.from('.navbar-end', {autoAlpha: 0, duration: dur, ease: "sine.inOut"}), pos);

        // SHOW FEATURED PROJECTS
        // trace("Show featured projects");
        const featured = gsap.utils.toArray(".project.link.featured");
        const controls = gsap.timeline();
        featured.forEach((project, index) => {
            project.classList.remove("hidden");
            project.classList.add("current");
            controls.add(gsap.to(project, { opacity: 1, y: y_delta, duration: dur * .76, ease: "sine.inOut" }), pos);
        });
        updateNav();
        /** applyAlternatingStyles(); **/

        /** 
         * CATEGORY SELECTION
         * Bring a category into view when its menu item is selected
         * */
        // trace("Set up category selection");
        const categories = gsap.utils.toArray("a.category");
        // trace("Categories: " + categories.length);
        categories.forEach(cat => {
            var label = document.getElementById("category_current");
            // When the user selects a category...
            cat.addEventListener("click", () => {

                // Update button states to highlight the selected category
                categories.forEach(item => {
                    item.classList.remove("active");
                    item.classList.remove("btn-active");
                    if (item.innerHTML == cat.innerHTML) {
                        if (item.classList.contains("btn")) {
                            item.classList.add("btn-active");
                        } else {
                            item.classList.add("active");
                        }
                    }
                })

                // Update the project previews to reflect the selected category
                const outro = gsap.timeline({ onComplete: clearCards });
                const intro = gsap.timeline({ onStart: showSelected, onStartParams: [cat] });
                projects.forEach(project => {
                    // clear all visible projects
                    if (!project.classList.contains("hidden")) {
                        outro.add(gsap.to(project, { opacity: 0, y: y_delta, duration: dur * .75, ease: "sine.inOut" }), pos);
                    }
                    console.log(cat.id == "all");
                    if (project.classList.contains(cat.id)) {
                        // display projects belonging to the selected category
                        intro.add(gsap.to(project, { opacity: 1, y: y_delta, duration: dur * .75, ease: "sine.inOut" }), pos);
                    }
                });

                // updateNav();

                const transition = gsap.timeline({});
                // intro.pause();
                transition.add(outro);
                transition.add(intro);
                transition.play();
            });
        });

        function updateNav() {
            // trace("update the nav buttons for the projects to reflect the new set ");
            var siblings = gsap.utils.toArray(".project.link.current");
            // trace(siblings.length + " items in the new set");
            siblings.forEach((item, index) => {
                // trace(index + " of " + siblings.length);
                var prev = gsap.utils.toArray("#modal_" + item.id + " button.prev")[0];
                var next = gsap.utils.toArray("#modal_" + item.id + " button.next")[0];
                // Hide by default
                prev.classList.add("hidden");
                next.classList.add("hidden");
                if (index > 0) {
                    var younger = siblings[index - 1];
                    prev.classList.remove("hidden");
                }
                if (index < siblings.length - 1) {
                    var older = siblings[index + 1];
                    next.classList.remove("hidden");
                }
            })
        }

        function navigate_projects(e) {
            var distance = e.target.id.split("_")[0] === "next" ? 1 : -1;
            var id = e.target.id.split("_")[1];
            var siblings = gsap.utils.toArray(".project.link.current");
            // trace("navigate_projects: " + siblings.length + " items in the current set");
            var index = siblings.indexOf(gsap.utils.toArray("#" + id)[0]);
            var outgoing = gsap.utils.toArray("#modal_" + id)[0];
            var incoming = gsap.utils.toArray("#modal_" + siblings[index + distance]["id"])[0];
            outgoing.close();
            incoming.showModal();
        }

        function clearCards() {
            // trace("clearCards");
            const projects = gsap.utils.toArray(".project.link");
            projects.forEach(project => {
                project.classList.add("hidden");
                project.classList.remove("current");
                project.classList.remove("even-column");
            })
        }

        function showSelected(cat) {
            var set = gsap.utils.toArray("." + cat.id);
            // trace("showSelected");
            set.forEach(project => {
                project.classList.remove("hidden");
                project.classList.add("current");
            });
            updateNav();
            /** applyAlternatingStyles(); **/
        };

        function applyAlternatingStyles() {
            const grid = document.getElementById('projects');
            const cols = window.getComputedStyle(grid).getPropertyValue('grid-template-columns').split(' ').length;
            const current = gsap.utils.toArray(".project.current");
            // console.log(current.length + " cards in " + cols + " columns");
            current.forEach((card, index) => {
                const colIndex = (index % cols) + 1; // Get the 1-based column index
                if ((cols > 1) && (colIndex % 2 !== 0)) {
                    card.classList.remove('even-column');
                } else {
                    card.classList.add('even-column');
                }
            });

        }
 
        window.addEventListener('resize', applyAlternatingStyles);
        let portrait = window.matchMedia("(orientation: portrait)");
        portrait.addEventListener("change", function (e) {
            applyAlternatingStyles();
        })
    });
</script>